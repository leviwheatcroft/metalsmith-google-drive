<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "lib/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h3">
        <a href="#default">default</a>
      </div>

      <div class="heading h3">
        <a href="#_scrape">_scrape</a>
      </div>

      <div class="heading h3">
        <a href="#streamfiles">streamFiles</a>
      </div>

      <div class="heading h3">
        <a href="#downloadfile">downloadFile</a>
      </div>

      <div class="heading h3">
        <a href="#frontmatter">frontMatter</a>
      </div>

      <div class="heading h3">
        <a href="#storefile">storeFile</a>
      </div>

      <div class="heading h3">
        <a href="#_getfiles">_getFiles</a>
      </div>

      <div class="heading h3">
        <a href="#_doauth">_doAuth</a>
      </div>

      <div class="heading h3">
        <a href="#_tokenflow">_tokenFlow</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> {
  compact,
  each,
  keys
} <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>
<span class="hljs-keyword">import</span> debug <span class="hljs-keyword">from</span> <span class="hljs-string">'debug'</span>
<span class="hljs-keyword">import</span> vow <span class="hljs-keyword">from</span> <span class="hljs-string">'vow'</span>
<span class="hljs-keyword">import</span> matter <span class="hljs-keyword">from</span> <span class="hljs-string">'gray-matter'</span>
<span class="hljs-keyword">import</span> readline <span class="hljs-keyword">from</span> <span class="hljs-string">'readline'</span>
<span class="hljs-keyword">import</span> highland <span class="hljs-keyword">from</span> <span class="hljs-string">'highland'</span>
<span class="hljs-keyword">import</span> google <span class="hljs-keyword">from</span> <span class="hljs-string">'googleapis'</span>
<span class="hljs-keyword">import</span> GoogleAuth <span class="hljs-keyword">from</span> <span class="hljs-string">'google-auth-library'</span>
<span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> {
  Store,
  params
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>

<span class="hljs-keyword">const</span> dbg = debug(<span class="hljs-string">'metalsmith-google-drive'</span>)
<span class="hljs-keyword">const</span> drive = google.drive(<span class="hljs-string">'v3'</span>)
<span class="hljs-keyword">let</span> oauth

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="default">
  <h3>
    <a href="#default" name="default" class="pilcrow"></a>
default
  </h3>
</div>
</div>
<div class="body">
<p>see README.md re: auth properties</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options</span>
<span class="dox_type">Object</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.src</span>
<span class="dox_type">String</span>
<span>google drive parent id folder
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.dest</span>
<span class="dox_type">String</span>
<span>path under which to place files for metalsmith
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.auth</span>
<span class="dox_type">Object</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.auth.client_id</span>
<span class="dox_type">String</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.auth.client_secret</span>
<span class="dox_type">String</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">options.auth.redirect_uris</span>
<span class="dox_type">Array</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">plugin</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">if</span> (!options) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'no options passed'</span>)
  <span class="hljs-keyword">if</span> (!options.src) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'required: options.src'</span>)
  <span class="hljs-keyword">if</span> (!options.dest) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'required: options.dest'</span>)
  <span class="hljs-keyword">if</span> (!options.auth) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'required: options.auth'</span>)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>if (options.cache !== undefined) cache = options.cache</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> Folder(options)
  <span class="hljs-keyword">return</span> store.plugin.bind(store)
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Folder</span> </span>{
  <span class="hljs-keyword">constructor</span> (options) {
    <span class="hljs-built_in">Object</span>.keys(options).forEach(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> { <span class="hljs-keyword">this</span>[key] = options[key] })
    <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.src.slice(<span class="hljs-number">-8</span>)
    <span class="hljs-keyword">this</span>.store = <span class="hljs-keyword">new</span> Store(<span class="hljs-keyword">this</span>.src)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.invalidateCache) {
      <span class="hljs-keyword">this</span>.store.invalidate()
      params.setLastRun(<span class="hljs-keyword">this</span>, <span class="hljs-literal">false</span>)
    }
  }
  plugin (files, metalsmith) {
    <span class="hljs-keyword">this</span>.files = files
    <span class="hljs-keyword">this</span>.metalsmith = metalsmith
    <span class="hljs-keyword">return</span> vow.resolve()
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> _doAuth(<span class="hljs-keyword">this</span>.auth))
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.scrape())
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.mergeStore())
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> params.setLastRun(<span class="hljs-keyword">this</span>))
    .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> vow.resolve(<span class="hljs-keyword">this</span>.files))
    .catch(dbg)
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_scrape">
  <h3>
    <a href="#_scrape" name="_scrape" class="pilcrow"></a>
_scrape
  </h3>
</div>
</div>
<div class="body">
<p>scrape files from google drive</p>
<p>nested highland stream...</p>
<ul>
<li>without backpressure a stream will just push everything into a slow
consumer which is kind of the antithesis of a stream (a lake?)</li>
<li>the calls to drive api do not have any inherant backpressure so it needs
to be created artificially. highlands <code>throttle</code> or <code>ratelimit</code> are based
on ms, so that would just be an arbitrary limit uneffected by how fast the
api is running. <code>parallel</code> allows to have x concurrent requests.</li>
<li><code>parallel</code> only works on a stream of streams, that means if you want
<code>generator().map( ... ).parallel(5)</code> then map <em>must</em> return a stream. In
this case the stream returned contains only a single promise. Think of it
more like a promise decorated with the highland api rather than an actual
stream.</li>
</ul>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">src</span>
<span class="dox_type">string</span>
<span>google drive parent folder id
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  scrape () {
    dbg(<span class="hljs-string">'scrape'</span>, <span class="hljs-keyword">this</span>.name)
    <span class="hljs-keyword">const</span> defer = vow.defer()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>returns a highland stream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">this</span>.streamFiles()
    .map(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>must return stream (or <em>highland decorated promise</em>)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">return</span> highland(
        vow.resolve(file)
        .then(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> <span class="hljs-keyword">this</span>.downloadFile(file))
        .then(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> <span class="hljs-keyword">this</span>.frontMatter(file))
        .then(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> <span class="hljs-keyword">this</span>.storeFile(file))
        .catch(dbg)
      )
    })
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>artificial backpressure</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    .parallel(<span class="hljs-number">5</span>)
    .toArray(<span class="hljs-function">(<span class="hljs-params">files</span>) =&gt;</span> {
      defer.resolve(files)
    })
    <span class="hljs-keyword">return</span> defer.promise()
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="streamfiles">
  <h3>
    <a href="#streamfiles" name="streamfiles" class="pilcrow"></a>
streamFiles
  </h3>
</div>
</div>
<div class="body">
<p>some rad highland stream magic!</p>
<ul>
<li>the highland constructor is passed a function which will be called every
time the stream is ready for more data</li>
<li>the two args passed to this fn are to <code>push</code> (queue?) data into the stream
and to <code>next</code> when there's a good opportunity to do something else to
consume the data</li>
<li>so basically every time the stream has capacity, we will request a page
from the API and push each file onto the stream. if there's no
<code>nextPageToken</code> then we notify the stream that there's no more.</li>
</ul>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">parent</span>
<span class="dox_type">String</span>
<span>id of parent folder
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  streamFiles () {
    <span class="hljs-keyword">let</span> pageToken = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">let</span> lastRun = params.getLastRun(<span class="hljs-keyword">this</span>)
    dbg(<span class="hljs-string">'lastRun'</span>, lastRun)
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> highland(<span class="hljs-function">(<span class="hljs-params">push, next</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> request = {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>build request object with query</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      request.auth = oauth
      request.fields = <span class="hljs-string">'files(id, name, mimeType, trashed)'</span>
      request.q = compact([
        <span class="hljs-string">'mimeType != "application/vnd.google-apps.folder"'</span>,
        <span class="hljs-string">`"<span class="hljs-subst">${<span class="hljs-keyword">this</span>.src}</span>" in parents`</span>,
        lastRun ? <span class="hljs-string">`modifiedTime &gt; "<span class="hljs-subst">${lastRun}</span>"`</span> : <span class="hljs-literal">false</span>
      ]).join(<span class="hljs-string">' and '</span>)
      <span class="hljs-keyword">if</span> (pageToken) request.pageToken = pageToken

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>async api call, no need to promisify because we bat for both teams ?</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      drive.files.list(request, (err, result) =&gt; {
        <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err)
        count += result.files.length
        each(result.files, (file) =&gt; {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>this is all we need to do to deal with deleted files</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          <span class="hljs-keyword">if</span> (file.trashed) {
            dbg(<span class="hljs-string">`ignoring trashed <span class="hljs-subst">${file.name}</span>`</span>)
            <span class="hljs-keyword">this</span>.store.removeResource(file.id)
          } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>push / emit file to the highland stream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            push(<span class="hljs-literal">null</span>, file)
          }
        })
        <span class="hljs-keyword">if</span> (!result.nextPageToken) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>close highland stream with special <code>highland.nil</code></p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          dbg(<span class="hljs-string">`<span class="hljs-subst">${count}</span> files to be updated`</span>)
          push(<span class="hljs-literal">null</span>, highland.nil)
        } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>indicate that more values can be retrieved</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">          pageToken = result.nextPageToken
          next()
        }
      })
    })
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="downloadfile">
  <h3>
    <a href="#downloadfile" name="downloadfile" class="pilcrow"></a>
downloadFile
  </h3>
</div>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">file</span>
<span class="dox_type">Object</span>
<span>as streadmed from _streamFiles
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  downloadFile (file) {
    dbg(<span class="hljs-string">`downloading <span class="hljs-subst">${file.name}</span>`</span>)

    <span class="hljs-keyword">const</span> defer = vow.defer()
    <span class="hljs-keyword">const</span> chunks = []
    drive.files.get({
      <span class="hljs-attr">auth</span>: oauth,
      <span class="hljs-attr">fileId</span>: file.id,
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p><code>alt: 'media'</code> triggers file download rather than just meta</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      alt: <span class="hljs-string">'media'</span>
    })
    .on(<span class="hljs-string">'data'</span>, (chunk) =&gt; {
      chunks.push(chunk)
    })
    .on(<span class="hljs-string">'end'</span>, () =&gt; {
      file.contents = Buffer.concat(chunks)
      defer.resolve(file)
    })
    .on(<span class="hljs-string">'error'</span>, (err) =&gt; defer.reject(err))
    <span class="hljs-keyword">return</span> defer.promise()
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="frontmatter">
  <h3>
    <a href="#frontmatter" name="frontmatter" class="pilcrow"></a>
frontMatter
  </h3>
</div>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">file</span>
<span class="dox_type">Object</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  frontMatter (file) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^text/</span>.exec(file.mimeType)) <span class="hljs-keyword">return</span> file
    <span class="hljs-keyword">let</span> meta = matter(file.contents.toString(<span class="hljs-string">'utf8'</span>))
    <span class="hljs-keyword">if</span> (keys(meta).length === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> vow.reject(<span class="hljs-string">`no front matter? <span class="hljs-subst">${file.name}</span>`</span>)
    }
    <span class="hljs-built_in">Object</span>.assign(
      file,
      { <span class="hljs-attr">contents</span>: meta.content },
      meta.data
    )
    <span class="hljs-keyword">return</span> file
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="storefile">
  <h3>
    <a href="#storefile" name="storefile" class="pilcrow"></a>
storeFile
  </h3>
</div>
</div>
<div class="body">
<p>store file in persist cache with drive id as key</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">file</span>
<span class="dox_type">Object</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  storeFile (file) {
    <span class="hljs-keyword">let</span> encoding = <span class="hljs-regexp">/^text/</span>.exec(file.mimeType) ? <span class="hljs-string">'utf8'</span> : <span class="hljs-string">'base64'</span>
    file.contents = file.contents.toString(encoding)
    <span class="hljs-keyword">this</span>.store.setResource(join(<span class="hljs-keyword">this</span>.dest, file.id), file)
    <span class="hljs-keyword">return</span> file
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_getfiles">
  <h3>
    <a href="#_getfiles" name="_getfiles" class="pilcrow"></a>
_getFiles
  </h3>
</div>
</div>
<div class="body">
<p>this gets files from local persistent store, <em>not</em> from drive</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">dest</span>
<span class="dox_type">String</span>
<span>path under which to store files
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  mergeStore () {
    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">this</span>.store.getResources(<span class="hljs-keyword">this</span>.dest)
    <span class="hljs-built_in">Object</span>.keys(store).forEach(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> encoding = <span class="hljs-regexp">/^text/</span>.exec(store[key].mimeType) ? <span class="hljs-string">'utf8'</span> : <span class="hljs-string">'base64'</span>
      store[key].contents = <span class="hljs-keyword">new</span> Buffer(store[key].contents, encoding)
    })
    dbg(
      <span class="hljs-string">`merging <span class="hljs-subst">${<span class="hljs-built_in">Object</span>.keys(store).length}</span> `</span> +
      <span class="hljs-string">`tracked files from <span class="hljs-subst">${<span class="hljs-keyword">this</span>.store.name}</span>`</span>
    )
    <span class="hljs-built_in">Object</span>.assign(<span class="hljs-keyword">this</span>.files, store)
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_doauth">
  <h3>
    <a href="#_doauth" name="_doauth" class="pilcrow"></a>
_doAuth
  </h3>
</div>
</div>
<div class="body">
<p>set up the API auth structure, retrieve cached token or request one</p>
<p>__ tokens __</p>
<ul>
<li>I haven't been able to figure out how long this token lasts for, I have a
feeling it might last until invalidated.</li>
<li>What happens to a token when the same client_secret is used to generate
another token, like on another machine</li>
</ul>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">auth</span>
<span class="dox_type">Object</span>
<span>see properties passed to googleAuth.OAuth2
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_doAuth</span> (<span class="hljs-params">auth</span>) </span>{
  <span class="hljs-keyword">if</span> (oauth) <span class="hljs-keyword">return</span> vow.resolve()
  dbg(<span class="hljs-string">'doing oAuth2'</span>)
  <span class="hljs-keyword">const</span> googleAuth = <span class="hljs-keyword">new</span> GoogleAuth()
  oauth = <span class="hljs-keyword">new</span> googleAuth.OAuth2(
    auth.client_id,
    auth.client_secret,
    auth.redirect_uris[<span class="hljs-number">0</span>]
  )
  <span class="hljs-keyword">return</span> vow.resolve()
  .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> params.getToken() || _tokenFlow())
  .then(<span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {
    oauth.credentials = token
  })
  .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> dbg(err))
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="dox">
<div class="summary">
<div class="pilwrap" id="_tokenflow">
  <h3>
    <a href="#_tokenflow" name="_tokenflow" class="pilcrow"></a>
_tokenFlow
  </h3>
</div>
</div>
<div class="body">
<p>usually this auth flow happens in your browser, but here we do it via CLI
this fn prints the auth url, which gives the user a code to paste back in</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_tokenFlow</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> defer = vow.defer()
  <span class="hljs-keyword">let</span> prompt
  <span class="hljs-keyword">const</span> authUrl = oauth.generateAuthUrl({
    <span class="hljs-attr">access_type</span>: <span class="hljs-string">'offline'</span>,
    <span class="hljs-attr">scope</span>: [<span class="hljs-string">'https://www.googleapis.com/auth/drive.readonly'</span>]
  })
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'authorise metalsmith-google-drive by visiting: '</span>, authUrl)
  prompt = readline.createInterface({
    <span class="hljs-attr">input</span>: process.stdin,
    <span class="hljs-attr">output</span>: process.stdout
  })
  prompt.question(<span class="hljs-string">'Enter the code from that page here: '</span>, (code) =&gt; {
    prompt.close()
    oauth.getToken(code, (err, result) =&gt; {
      <span class="hljs-keyword">if</span> (err) {
        dbg(err)
        defer.reject(err)
      } <span class="hljs-keyword">else</span> {
        params.setToken(result)
        defer.resolve(result)
      }
    })
  })
  <span class="hljs-keyword">return</span> defer.promise()
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> plugin
<span class="hljs-keyword">export</span> {
  plugin
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
